{
  "id": "539E1E16-0680-4F8E-85D0-95B6FDE76E8C",
  "name": "CreateAndQueryChangeRequest",
  "friendlyName": "ServiceNow Change Management",
  "description": "Create new change request in ServiceNow and check for its status",
  "author": "Microsoft",
  "helpMarkDown": "",
  "category": "Utility",
  "visibility": [
    "Release"
  ],
  "runsOn": [
    "ServerGate"
  ],
  "version": {
    "Major": 0,
    "Minor": 1,
    "Patch": 0
  },
  "instanceNameFormat": "ServiceNow change management",
  "groups": [
    {
      "name": "schedule",
      "displayName": "Schedule of change request",
      "isExpanded": false
    },
    {
      "name": "advancedInputs",
      "displayName": "Advanced",
      "isExpanded": false
    },
    {
      "name": "completionOptions",
      "displayName": "Success criteria",
      "isExpanded": true
    }
  ],
  "inputs": [
    {
      "name": "ServiceNowConnection",
      "type": "connectedService:ServiceNow",
      "label": "ServiceNow connection",
      "defaultValue": "",
      "required": "true",
      "helpMarkDown": "Connection to the ServiceNow instance used for change management."
    },
    {
      "name": "changeType",
      "type": "pickList",
      "label": "Change Type",
      "required": "false",
      "helpMarkDown": "Choose or type change type (label or value) of the change request.",
      "properties": {
        "EditableOptions": "True"
      },
      "options": {
        "Normal": "Normal",
        "Standard": "Standard",
        "Emergency": "Emergency"
      },
      "defaultValue": "Normal"
    },
    {
      "name": "standardChanges",
      "type": "pickList",
      "label": "Standard Changes",
      "required": "false",
      "helpMarkDown": "Choose or type Standard change template for the change request.",
      "properties": {
        "EditableOptions": "True"
      },
      "defaultValue": "",
      "visibleRule": "changeType = Standard"
    },
    {
      "name": "changeRequestAction",
      "type": "radio",
      "label": "Action",
      "required": "false",
      "helpMarkDown": "Choose action for the change request",
      "properties": {
        "EditableOptions": "False"
      },
      "options": {
        "createNew": "Create new change request",
        "useExisting": "Query existing change request"
      },
      "defaultValue": "createNew"
    },
    {
      "name": "changeQueryCriteria",
      "type": "pickList",
      "label": "Change query criteria",
      "required": "false",
      "helpMarkDown": "Choose criteria for querying change request. If Multiple records are returned, Last record will be selected.",
      "properties": {
        "EditableOptions": "false"
      },
      "options": {
        "changeRequestNumber": "Change request number",
        "correlationId": "Correlation Id",
        "queryString": "Query string"
      },
      "defaultValue": "changeRequestNumber",
      "visibleRule": "changeRequestAction = useExisting"
    },
    {
      "name": "changeQueryValue",
      "type": "string",
      "label": "Change query value",
      "required": "true",
      "helpMarkDown": "Change query value",
      "visibleRule": "changeRequestAction = useExisting"
    },
    {
      "name": "shortdescription",
      "type": "string",
      "label": "Short Description",
      "required": "true",
      "defaultValue": "Deployment to $(Release.EnvironmentName) of Release $(Release.ReleaseId)",
      "helpMarkDown": "Short description of the change request."
    },
    {
      "name": "description",
      "type": "string",
      "label": "Description",
      "required": "false",
      "groupName": "advancedInputs",
      "defaultValue": "Deployment to $(Release.EnvironmentName) of Release $(Release.ReleaseId)",
      "helpMarkDown": "Description of the change request."
    },
    {
      "name": "category",
      "type": "pickList",
      "label": "Category",
      "required": "false",
      "defaultValue": "",
      "groupName": "advancedInputs",
      "helpMarkDown": "Choose or type category (label or value) of the change request.",
      "properties": {
        "EditableOptions": "True"
      }
    },
    {
      "name": "priority",
      "type": "pickList",
      "label": "Priority",
      "required": "false",
      "defaultValue": "",
      "groupName": "advancedInputs",
      "helpMarkDown": "Choose or type priority (label or value) of the change request.",
      "properties": {
        "EditableOptions": "True"
      }
    },
    {
      "name": "risk",
      "type": "pickList",
      "label": "Risk",
      "required": "false",
      "defaultValue": "",
      "groupName": "advancedInputs",
      "helpMarkDown": "Choose or type risk (label or value) of the change request.",
      "properties": {
        "EditableOptions": "True"
      }
    },
    {
      "name": "impact",
      "type": "pickList",
      "label": "Impact",
      "required": "false",
      "defaultValue": "",
      "groupName": "advancedInputs",
      "helpMarkDown": "Choose or type impact (label or value) of the change request.",
      "properties": {
        "EditableOptions": "True"
      }
    },
    {
      "name": "configurationitem",
      "type": "pickList",
      "label": "Configuration Item",
      "required": "false",
      "defaultValue": "",
      "groupName": "advancedInputs",
      "helpMarkDown": "Choose or type item or service (display name or sys_id) defined in ServiceNow that is affected by this pipeline.",
      "properties": {
        "EditableOptions": "True"
      }
    },
    {
      "name": "assignmentgroup",
      "type": "pickList",
      "label": "Assignment Group",
      "required": "false",
      "defaultValue": "",
      "groupName": "advancedInputs",
      "helpMarkDown": "Choose or type group of ServiceNow users who can approve and update the change request.",
      "properties": {
        "EditableOptions": "True"
      }
    },
    {
      "name": "schedulestarttime",
      "type": "string",
      "label": "Planned start date",
      "required": "false",
      "defaultValue": "",
      "groupName": "schedule",
      "helpMarkDown": "Planned start time of the change request in UTC (yyyy-MM-ddTHH:mm:ssZ format). eg. 2018-01-31T07:56:59Z"
    },
    {
      "name": "scheduleendtime",
      "type": "string",
      "label": "Planned end date",
      "required": "false",
      "defaultValue": "",
      "groupName": "schedule",
      "helpMarkDown": "Planned end time of the change request in UTC (yyyy-MM-ddTHH:mm:ssZ format). eg. 2018-01-31T07:56:59Z"
    },
    {
      "name": "otherParameters",
      "type": "multiLine",
      "label": "Additional change request parameters",
      "defaultValue": "",
      "required": "false",
      "groupName": "advancedInputs",
      "helpMarkDown": "Additional change request properties to set. Specified as Key-value pairs in json format, name being the field name (not label) prefixed with 'u_' in ServiceNow and a valid value. Invalid properties are ignored.",
      "properties": {
        "editorExtension": "ms.vss-services-azure.azure-servicebus-message-grid"
      }
    },
    {
      "name": "DesiredExitStatus",
      "type": "pickList",
      "label": "Desired status of change request",
      "required": "true",
      "groupName": "completionOptions",
      "helpMarkDown": "Choose or type status of change request that indicates the change request is ready to be implemented. Gate would succeed when the the change request status is same as the provided value.",
      "properties": {
        "EditableOptions": "True"
      }
    }
  ],
  "dataSourceBindings": [
    {
      "target": "standardChanges",
      "endpointId": "$(ServiceNowConnection)",
      "dataSourceName": "StandardChanges",
      "resultTemplate": "{ \"Value\" : \"{{sys_id}}\", \"DisplayValue\" : \"{{sys_name}}\" }"
    },
    {
      "target": "priority",
      "endpointId": "$(ServiceNowConnection)",
      "dataSourceName": "Priority"
    },
    {
      "target": "risk",
      "endpointId": "$(ServiceNowConnection)",
      "dataSourceName": "Risk"
    },
    {
      "target": "impact",
      "endpointId": "$(ServiceNowConnection)",
      "dataSourceName": "Impact"
    },
    {
      "target": "category",
      "endpointId": "$(ServiceNowConnection)",
      "dataSourceName": "Category"
    },
    {
      "target": "DesiredExitStatus",
      "endpointId": "$(ServiceNowConnection)",
      "dataSourceName": "State"
    },
    {
      "target": "configurationitem",
      "endpointId": "$(ServiceNowConnection)",
      "dataSourceName": "Configuration Item"
    },
    {
      "target": "assignmentgroup",
      "endpointId": "$(ServiceNowConnection)",
      "dataSourceName": "Assignment Group"
    }
  ],
  "execution": {
    "HttpRequestChain": {
      "Execute": [
        {
          "RequestInputs": { // Create new change request
            "EndpointId": "$(ServiceNowConnection)",
            "EndpointUrl": "$(endpoint.url)/api/now/import/x_mioms_azpipeline_change_request_import",
            "Method": "POST",
            "Body": "{  \"u_correlation_id\": \"{{#newGuid}}{{/newGuid}}\",\"u_x_mioms_azpi_eline_metadata\": \"Release: $(RELEASE.RELEASEWEBURL) \\r\\n EnvironmentName: $(RELEASE.ENVIRONMENTNAME) \\r\\n Requested By : $(RELEASE.DEPLOYMENT.REQUESTEDFOR)\", \"u_short_description\": \"$(shortdescription)\"{{#if description}}, \"u_description\": \"$(description)\" {{/if}},\"u_type\": \"$(changeType)\"{{#if category}}, \"u_category\": \"$(category)\"{{/if}}{{#if priority}}, \"u_priority\": \"$(priority)\"{{/if}}{{#if risk}}, \"u_risk\": \"$(risk)\"{{/if}}{{#if impact}}, \"u_impact\": \"$(impact)\"{{/if}}{{#if configurationitem}}, \"u_cmdb_ci\": \"$(configurationitem)\" {{/if}}{{#if assignmentgroup}}, \"u_assignment_group\": \"$(assignmentgroup)\"{{/if}}, \"u_requested_by_date\": \"{{toDateTimeFormat '$(RELEASE.DEPLOYMENT.STARTTIME)' 'yyyy-MM-dd HH:mm:ss'}}\", \"u_start_date\": \"{{#if schedulestarttime}}{{toDateTimeFormat '$(schedulestarttime)' 'yyyy-MM-dd HH:mm:ss'}}{{/if}}\",  \"u_end_date\": \"{{#if scheduleendtime}}{{toDateTimeFormat '$(scheduleendtime)' 'yyyy-MM-dd HH:mm:ss'}}{{/if}}\" {{#if otherParameters}}{{toCommaSeparatedKeyValueList otherParameters true}}{{/if}} {{#if standardChanges}} , \"template_id\": \"$(standardChanges)\" {{/if}} }",
            "Headers": "{\"Content-Type\":\"application/json\", \"Accept\":\"application/json\"}",
            "WaitForCompletion": "false",
            "Expression": "eq(jsonpath('$.result[0].status')[0], 'inserted')"
          },
          "ExecutionOptions": {
            "OutputVariables": "{\"CHANGE_SYSTEM_ID\" :  \"jsonpath('$.result[0].sys_id')[0]\", \"CHANGE_REQUEST_NUMBER\" :  \"jsonpath('$.result[0].display_value')[0]\"}",
            // skip section (if action is not createNew) or  (if action is create new and Change system ID is not empty)
            "SkipSectionExpression": "or(eq(eq(taskInputs['changeRequestAction'], 'createNew'), false), and(eq(taskInputs['changeRequestAction'], 'createNew'), eq(isNullOrEmpty(variables['CHANGE_SYSTEM_ID']), false)))"
          }
        },
        {
          "RequestInputs": { // Querying newly created change request by sys_id
            "EndpointId": "$(ServiceNowConnection)",
            "EndpointUrl": "$(endpoint.url)/api/now/table/change_request/$(CHANGE_SYSTEM_ID)?sysparm_fields=state,number&&sysparm_display_value=true",
            "Method": "GET",
            "Headers": "{\"Content-Type\":\"application/json\", \"Accept\":\"application/json\"}",
            "WaitForCompletion": "false",
            "Expression": "eq(jsonpath('$.result.state')[0], '$(DesiredExitStatus)')"
          },
          "ExecutionOptions": {
            // skip section (if action is not create new) or ( action is create new but Change system ID is empty)
            "SkipSectionExpression": "or(eq(eq(taskInputs['changeRequestAction'], 'createNew'), false), and(eq(taskInputs['changeRequestAction'], 'createNew'), eq(isNullOrEmpty(variables['CHANGE_SYSTEM_ID']), true)))"
          }
        },
        {
          "RequestInputs": { // Querying change request by number
            "EndpointId": "$(ServiceNowConnection)",
            "EndpointUrl": "$(endpoint.url)/api/now/table/change_request?sysparm_query=number=$(changeQueryValue)^ORDERBYDESCsys_created_on&sysparm_fields=state,number&&sysparm_display_value=true",
            "Method": "GET",
            "Headers": "{\"Content-Type\":\"application/json\", \"Accept\":\"application/json\"}",
            "WaitForCompletion": "false",
            "Expression": "eq(jsonpath('$.result.state')[0], '$(DesiredExitStatus)')"
          },
          "ExecutionOptions": {
            "SkipSectionExpression": "eq(eq(taskInputs['changeQueryCriteria'], 'changeRequestNumber'), false)"
          }
        },
        {
          "RequestInputs": { // Querying change request by correlation id
            "EndpointId": "$(ServiceNowConnection)",
            "EndpointUrl": "$(endpoint.url)/api/now/table/change_request?sysparm_query=correlation_id=$(changeQueryValue)^ORDERBYDESCsys_created_on&sysparm_fields=state,number&&sysparm_display_value=true",
            "Method": "GET",
            "Headers": "{\"Content-Type\":\"application/json\", \"Accept\":\"application/json\"}",
            "WaitForCompletion": "false",
            "Expression": "eq(jsonpath('$.result.state')[0], '$(DesiredExitStatus)')"
          },
          "ExecutionOptions": {
            "SkipSectionExpression": "eq(eq(taskInputs['changeQueryCriteria'], 'correlationId'), false)"
          }
        },
        {
          "RequestInputs": { // Querying change request using query string
            "EndpointId": "$(ServiceNowConnection)",
            "EndpointUrl": "$(endpoint.url)/api/now/table/change_request?sysparm_query=$(changeQueryValue)^ORDERBYDESCsys_created_on&sysparm_fields=state,number&&sysparm_display_value=true",
            "Method": "GET",
            "Headers": "{\"Content-Type\":\"application/json\", \"Accept\":\"application/json\"}",
            "WaitForCompletion": "false",
            "Expression": "eq(jsonpath('$.result.state')[0], '$(DesiredExitStatus)')"
          },
          "ExecutionOptions": {
            "SkipSectionExpression": "eq(eq(taskInputs['changeQueryCriteria'], 'queryString'), false)"
          }
        }
      ]
    }
  },
  "OutputVariables": [
    {
      "name": "CHANGE_REQUEST_NUMBER",
      "description": "Number of the change request created in ServiceNow"
    },
    {
      "name": "CHANGE_SYSTEM_ID",
      "description": "System Id of the change request created in ServiceNow"
    }
  ]
}
