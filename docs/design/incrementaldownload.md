# Incremental Download

## Overview
The feature is to allow Incremental Download of the Artifact in release so that all of the artifact items are not downloaded from the source provider and can be retrieved from an artifact cache maintained on the agent.

If services storing builds provide hash of the artifact file content, it can be leveraged to perform incremental download of artifacts. Since most of the popular services (Jenkins/TeamCity) do not provide file content hashes, solution is to generate the hashes before publishing the artifact and use this information during artifact download.

## Task Changes
A new task will be created named `Generate Artifact Metadata` that will generate `artifact-metadata.csv` file containing list of file paths and their file content hashes mapped to one another, created in the same directory as that of the artifacts. This might collide in the rare case where the artifact already has an `artifact-metadata.csv` file. This can be handled in future or worked around.

This task can be used when build is generated with VSTS Build. Similar task can be written when build is generated by Jenkins/TeamCity etc. 

In Download Fileshare Artifact Task: under advanced options, there will be an option to enable Incremental Download

##### artifact-metadata.csv example
| FilePath | Hash |
| --- | --- |
| File3.txt | 5C9D91BD562B0A45E5FFE44F7FB42563380BCBC80A06A49588F73ECB90AAFA1B |
| Folder1\File1.txt | ADE014E8CD3D5B1547DD42A8BB1D74763A46A5D4EC8263FC6705A52D53DC583B |
| Folder1\File2.txt | ADE014E8CD3D5B1547DD42A8BB1D74763A46A5D4EC8263FC6705A52D53DC583B |

## Artifact Engine Changes
A CacheProvider will be initialized with a “Hash” that reads the old artifact-metadata.csv

#### PsuedoCode
The following psuedo-code is invoked in the `artifact-engine`
```
  If(deploymentInput.enableIncrementalDownload is false)
	{
		//download all the artifacts
		Return releasedefinition.Artifacts;
	}
  Else
	{
		//download the artifacts incrementally
    		Initialize cache by reading the hash of artifact type.
		If(artifactItem is in cache)
		{
			//download from the cache
			Return cache.artifactItem;
		}
		Else
		{
			//download from the sourceProvider
			Return sourceProvider.artifactItem;
		}
	}
```

A new cache directory will be generated by the artifact engine under the folder _work\ArtifactEngineCache\SHA256HashofArtifact\ where the hash will be calculated by the following keys corresponding to different artifact types(where the key will be an input to the artifact-engine):
- Keys:
  - Build Artifacts : CollectionID.ProjectID.buildDefinitionID
  - Jenkins Artifacts : JenkinsURL.JobID
  - TeamCity Artifacts : teamCityURL.BuildConfigurationID

The new  artifact-metadata.csv will be read by artifact engine and the hashes will be stored in the artifactItemStore along with the artifactItems.

When worker call getItems to retrieve an item, cacheProvider will be called to check whether that item is present in cache or not. If yes, then item will be fetched from the cache otherwise from the sourceProvider itself.

Finally, when all the files are put to the desired destination, they will be copied to the appropriate cache location based on the hash calculated, to update the cache.

An additional .verify file will also be generated to check the correctness of the cache(i.e. whether the cache has been successfully updated or it failed in between).

Validation(checking if the hash of the downloaded files matches the hash in the corresponding artifact-metadata.csv file) of the downloaded files will be done while copying them to the cache with the option to skip the validation step. The validation step in itself has no overhead but the copying of files require an extra disk read(while reading from destination) and an extra disk write(writing to the cache).

For Cache Cleanup the .verify file will contain a lastUpdatedOn which tells when was the folder last used. The agent will iterate over all the folders in artifact engine cache and delete all those which are older than 30 days by reading the .verify file of each folder.


## Artifact source changes
Also, while linking Artifact during Release definition an option will be provided for incrementally downloading the artifact.
